---

- name: install bind
  apt:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - bind9
      - bind9utils
      - bind9-doc
  tags: [ install ]

- name: Copy named conf log file
  template:
    src: named.conf.log.j2
    dest: /etc/bind/named.conf.log
    backup: yes
    owner: root
    group: bind
    mode: 0660
  notify: restart named

- name: Copy named conf file
  template:
    src: named.conf.options.j2
    dest: /etc/bind/named.conf.options
    backup: yes
    owner: root
    group: bind
    mode: 0660
  notify: restart named


- name: Copy named conf local file
  template:
    src: named.conf.local.j2
    dest: /etc/bind/named.conf.local
    backup: yes
    owner: root
    group: bind
    mode: 0640
  notify: restart named

- name: Make zones directory
  file:
    path: /var/lib/bind/zones
    state: directory
    owner: root
    group: bind
    mode: 0750

- name: Copy default zone data
  template:
    src: default-zone-data.j2
    dest: /var/lib/bind/zones/default-zone-data
    owner: root
    group: bind
    mode: 0640

- name: Copy alcafaz.test forward file
  template:
    src: db.forward.alcafaz.test.j2
    dest: /var/lib/bind/zones/db.{{domain}}
    owner: root
    group: bind
    mode: 0640
  with_dict: "{{ records }}"
  notify: restart named

- name: Copy alcafaz.test reverse file
  template:
    src: db.reverse.alcafaz.test.j2
    dest: /var/lib/bind/zones/db.{{rev_domain}}
    owner: root
    group: bind
    mode: 0640
  with_dict: "{{ records }}"
  notify: restart named


- block:

  - name: Copy diogof.test forward file
    template:
      src: db.forward.diogof.test.j2
      dest: /var/lib/bind/zones/db.diogof.test
      owner: root
      group: bind
      mode: 0640
    notify: restart named

  when: other_zone == true

- name: Open firewall port
  ufw:
    rule: allow
    port: '53'
