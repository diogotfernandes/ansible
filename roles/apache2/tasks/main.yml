---
# tasks file for apache2

- name: Verificar OS
  fail:  msg="This role is not supported in {{ansible_os_family}} OS"
  when: ansible_os_family != "Debian"

- name: Instalar apache2
  apt: name="{{ apache2_packages }}" state=present
  notify: restart apache2

- name: Create vhosts
  template:
    src: vhost.conf.j2
    dest: /etc/apache2/sites-available/{{ item.name }}.conf
    backup: yes
    owner: root
    group: root
    mode: 0644
  with_items: "{{ apache2_vhost }}"
  when: apache2_create_vhost

- name: Create dir to vhost
  file:
    path: "{{ apache2_document_root }}/{{ item.name }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  with_items: "{{ apache2_vhost }}"
  when: apache2_create_vhost

# Criar loop para ativar os vhost's criados acima
- name: Activate vhost
  command: a2ensite {{ item.name }}
  notify: restart apache2
  with_items: "{{ apache2_vhost }}"
  when: apache2_create_vhost

- name: Check apache2 config
  shell: apache2ctl configtest
  register: apache2_test_config

- debug: msg="{{ apache2_test_config }}"

- name: Remove default vhost
  file:
    path: "{{ apache2_path }}/sites-enabled/{{ apache2_default_vhost_name }}"
    state: absent
  notify: restart apache2
  when: apache2_remove_default_vhost

- name: Add entry to UFW
  ufw:
    rule: 'allow'
    port: "{{ apache2_default_port }}"
    proto: tcp
